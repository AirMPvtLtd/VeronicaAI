<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Veronica AI - Advanced Assistant</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=YOUR_RESPONSIVEVOICE_API_KEY"></script>
  <script>
    // Fallback for responsivevoice.js
    if (!window.responsiveVoice) {
      console.warn("ResponsiveVoice not loaded. Falling back to Web Speech API.");
    }
  </script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #0f0f1a;
      color: #e6e6e6;
      text-align: center;
      padding: 20px;
      background-image: radial-gradient(circle at 10% 20%, #1a1a2e 0%, #0f0f1a 90%);
    }
    .main-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    .panel {
      background: rgba(30, 30, 50, 0.7);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #333344;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      min-width: 300px;
      flex: 1;
    }
    .tech-panel {
      background: rgba(20, 20, 40, 0.8);
      max-height: 500px;
      overflow-y: auto;
    }
    button {
      padding: 12px 25px;
      font-size: 16px;
      margin: 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
      touch-action: manipulation;
    }
    #startBtn { 
      background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
      color: white;
    }
    #stopBtn { 
      background: linear-gradient(135deg, #E53935 0%, #B71C1C 100%);
      color: white;
    }
    .output {
      text-align: left;
      white-space: pre-wrap;
      min-height: 300px;
      font-family: 'Courier New', monospace;
      line-height: 1.6;
    }
    .status-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 15px;
      gap: 10px;
    }
    .status-indicator {
      font-size: 24px;
      height: 30px;
    }
    .active { 
      color: #00FF9D; 
      animation: pulse 1.5s infinite;
      text-shadow: 0 0 8px rgba(0, 255, 157, 0.7);
    }
    .noise-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #333;
    }
    .noise-active {
      background: #00FF9D;
      box-shadow: 0 0 10px #00FF9D;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    h1 {
      color: #00FF9D;
      text-shadow: 0 0 10px rgba(0, 255, 157, 0.5);
      margin-bottom: 30px;
    }
    h2 {
      color: #BA68C8;
      border-bottom: 1px solid #333344;
      padding-bottom: 10px;
    }
    .user-text { color: #4FC3F7; }
    .ai-text { color: #00FF9D; }
    .system-text { color: #BA68C8; font-style: italic; }
    .tech-text { color: #FFA726; }
    .language-selector {
      margin: 15px;
      padding: 8px 15px;
      border-radius: 20px;
      background: #1a1a2e;
      color: white;
      border: 1px solid #333344;
    }
    .code-block {
      background: #1a1a2e;
      padding: 10px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      color: #FFA726;
      margin: 10px 0;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîÆ <span style="color:#00FF9D">VERONICA</span> - AI Assistant for <span style="color:#4FC3F7">Abul Sir</span></h1>
  
  <select class="language-selector" id="languageSelector">
    <option value="en-US">English</option>
    <option value="hi-IN">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
  </select><br>
  
  <button id="startBtn">‚ñ∂ Activate Veronica</button>
  <button id="stopBtn">‚èπ Deactivate</button>
  
  <div class="status-container">
    <div class="status-indicator" id="statusIndicator"></div>
    <div class="noise-indicator" id="noiseIndicator"></div>
  </div>
  
  <div class="main-container">
    <div class="panel">
      <h2>Conversation</h2>
      <div class="output" id="responseBox">> System: Veronica ready for activation</div>
    </div>
    
    <div class="panel tech-panel">
      <h2>Technical Analysis</h2>
      <div class="output" id="techBox">> Technical queries will appear here</div>
    </div>
  </div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const responseBox = document.getElementById("responseBox");
    const techBox = document.getElementById("techBox");
    const statusIndicator = document.getElementById("statusIndicator");
    const noiseIndicator = document.getElementById("noiseIndicator");
    const languageSelector = document.getElementById("languageSelector");

    let running = false;
    let currentLanguage = "en-US";
    const assistantName = "Veronica";
    const userName = "Abul Sir";
    let isSpeaking = false;
    let audioStream;
    let abortController = new AbortController();
    let recognitionTimeout;

    const systemPrompt = {
      "en-US": `You are ${assistantName}, an advanced AI assistant for ${userName}. Respond with:
      - Technical precision like JARVIS from Iron Man
      - Concise bullet points for complex answers
      - Professional yet witty tone
      - Always address ${userName} as "Sir"
      - Never read symbols or your own name
      - For coding/tech questions, provide both explanation and code`,
      
      "hi-IN": `‡§Ü‡§™ ${assistantName} ‡§π‡•à‡§Ç, ${userName} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§â‡§®‡•ç‡§®‡§§ AI ‡§∏‡§π‡§æ‡§Ø‡§ï‡•§ ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ‡§è‡§Å ‡§¶‡•á‡§Ç:
      - ‡§Ü‡§Ø‡§∞‡§® ‡§Æ‡•à‡§® ‡§ï‡•á JARVIS ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä ‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ
      - ‡§ú‡§ü‡§ø‡§≤ ‡§ú‡§µ‡§æ‡§¨‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§¨‡•Å‡§≤‡•á‡§ü ‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏
      - ‡§™‡•á‡§∂‡•á‡§µ‡§∞ ‡§™‡§∞ ‡§•‡•ã‡§°‡§º‡§æ ‡§Æ‡§ú‡§æ‡§ï‡§ø‡§Ø‡§æ ‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§º
      - ‡§π‡§Æ‡•á‡§∂‡§æ ${userName} ‡§ï‡•ã "‡§∏‡§∞" ‡§ï‡§π‡§ï‡§∞ ‡§∏‡§Ç‡§¨‡•ã‡§ß‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç
      - ‡§ï‡§≠‡•Ä ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï ‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§® ‡§™‡§¢‡§º‡•á‡§Ç
      - ‡§ï‡•ã‡§°‡§ø‡§Ç‡§ó/‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡•Ä‡§ï‡§∞‡§£ ‡§î‡§∞ ‡§ï‡•ã‡§° ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§¶‡•á‡§Ç`
    };

    const stopCommands = {
      "en-US": ["stop", "wait", "mute", "shut up", "quiet", "veronica stop"],
      "hi-IN": ["‡§∞‡•Å‡§ï‡•ã", "‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•ã", "‡§ö‡•Å‡§™ ‡§∞‡§π‡•ã", "‡§†‡§π‡§∞‡•ã", "‡§∞‡•Å‡§ï ‡§ú‡§æ‡§ì", "‡§µ‡•á‡§∞‡•ã‡§®‡§ø‡§ï‡§æ ‡§∞‡•Å‡§ï‡•ã"]
    };

    function addToOutput(text, type = "system", target = "main") {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === "user" ? "üó£ You" : 
                    type === "ai" ? "ü§ñ " + assistantName : 
                    type === "tech" ? "‚öôÔ∏è Tech" : "> System";
      
      const targetBox = target === "tech" ? techBox : responseBox;
      const messageDiv = document.createElement("div");
      const prefixSpan = document.createElement("span");
      prefixSpan.textContent = `[${timestamp}] ${prefix}: `;
      const contentSpan = document.createElement("span");
      contentSpan.className = `${type}-text`;
      contentSpan.textContent = text;
      messageDiv.appendChild(prefixSpan);
      messageDiv.appendChild(contentSpan);
      targetBox.appendChild(messageDiv);
      targetBox.scrollTop = targetBox.scrollHeight;
    }

    function cleanResponse(text) {
      return text.replace(/[\[\]\(\)\{\}\<\>\*\-\+\=\_\&\^\%\$\#\@\!]/g, " ")
                 .replace(/\s+/g, " ")
                 .trim();
    }

    function extractTechContent(text) {
      const codeBlocks = text.match(/```[\s\S]*?```/g) || [];
      const techExplanation = text.replace(/```[\s\S]*?```/g, "")
                                 .replace(/(?:https?|ftp):\/\/[\n\S]+/g, "");
      return { codeBlocks, techExplanation };
    }

    function shouldStopSpeech(text) {
      const lowerText = text.toLowerCase();
      return stopCommands[currentLanguage].some(cmd => lowerText.includes(cmd.toLowerCase()));
    }

    function speakText(text, lang) {
      if (isSpeaking) {
        if (window.responsiveVoice) responsiveVoice.cancel();
        else window.speechSynthesis.cancel();
        isSpeaking = false;
      }
      
      isSpeaking = true;
      const cleanedText = cleanResponse(text);
      
      if (window.responsiveVoice) {
        const voice = lang === "hi-IN" ? "Hindi Male" : "UK English Male";
        responsiveVoice.speak(cleanedText, voice, {
          rate: 0.95,
          pitch: 1.0,
          onstart: () => {
            noiseIndicator.classList.add("noise-active");
          },
          onend: () => {
            isSpeaking = false;
            noiseIndicator.classList.remove("noise-active");
            if (running) setTimeout(startVoiceRecognition, 500);
          }
        });
      } else {
        // Fallback to Web Speech API
        const utterance = new SpeechSynthesisUtterance(cleanedText);
        utterance.lang = lang === "hi-IN" ? "hi-IN" : "en-GB";
        utterance.rate = 0.95;
        utterance.pitch = 1.0;
        utterance.onstart = () => {
          noiseIndicator.classList.add("noise-active");
        };
        utterance.onend = () => {
          isSpeaking = false;
          noiseIndicator.classList.remove("noise-active");
          if (running) setTimeout(startVoiceRecognition, 500);
        };
        window.speechSynthesis.speak(utterance);
      }
    }

    function startVoiceRecognition() {
      if (!running || isSpeaking) return;
      
      statusIndicator.innerHTML = "üîÆ <span style='color:#00FF9D'>Listening...</span>";
      statusIndicator.classList.add("active");
      
      if (annyang) {
        annyang.abort();
        annyang.start({ autoRestart: false });
        clearTimeout(recognitionTimeout);
        recognitionTimeout = setTimeout(() => {
          if (running && !isSpeaking) startVoiceRecognition();
        }, 5000);
      } else {
        addToOutput("Speech recognition unavailable. Please check browser permissions.", "system");
      }
    }

    function stopVoiceRecognition() {
      statusIndicator.innerHTML = "";
      statusIndicator.classList.remove("active");
      noiseIndicator.classList.remove("noise-active");
      if (annyang) annyang.abort();
      clearTimeout(recognitionTimeout);
    }

    function initializeSpeechRecognition() {
      if (!annyang) {
        addToOutput("Speech recognition unavailable. Please check browser permissions.", "system");
        return;
      }

      currentLanguage = languageSelector.value;
      annyang.setLanguage(currentLanguage === "hi-IN" ? "hi-IN" : "en-US");
      
      annyang.addCommands({
        "*text": function(text) {
          console.log("Recognized:", text);
          
          if (shouldStopSpeech(text)) {
            if (window.responsiveVoice) responsiveVoice.cancel();
            else window.speechSynthesis.cancel();
            isSpeaking = false;
            addToOutput("Command acknowledged. I've stopped speaking.", "ai");
            startVoiceRecognition();
            return;
          }
          
          if (isSpeaking) {
            if (window.responsiveVoice) responsiveVoice.cancel();
            else window.speechSynthesis.cancel();
            isSpeaking = false;
          }
          
          processUserInput(text);
        }
      });

      annyang.addCallback("error", function(err) {
        console.error("Speech error:", err);
        if (running && !isSpeaking) setTimeout(startVoiceRecognition, 1000);
      });

      annyang.addCallback("end", function() {
        if (running && !isSpeaking) setTimeout(startVoiceRecognition, 500);
      });
    }

    async function processUserInput(text) {
      addToOutput(text, "user");
      stopVoiceRecognition();

      try {
        abortController.abort();
        abortController = new AbortController();
        
        const response = await getAIResponse(text, abortController.signal);
        
        const mainResponse = response.replace(/```[\s\S]*?```/g, "");
        addToOutput(mainResponse, "ai");
        speakText(mainResponse, currentLanguage);
        
        const { codeBlocks, techExplanation } = extractTechContent(response);
        if (techExplanation.trim().length > 0) {
          addToOutput(techExplanation, "tech", "tech");
        }
        codeBlocks.forEach(code => {
          addToOutput(code.replace(/```/g, ""), "tech", "tech");
        });
        
      } catch (err) {
        if (err.name !== "AbortError") {
          console.error("API error:", err);
          addToOutput(`System error: ${err.message}`, "system");
          if (running && !isSpeaking) startVoiceRecognition();
        }
      }
    }

    async function getAIResponse(userInput, signal) {
      // Placeholder: API call should be handled server-side
      // Example server-side endpoint: "/api/chat"
      /*
      const response = await fetch("/api/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "mistral-large-latest",
          messages: [
            { role: "system", content: systemPrompt[currentLanguage] },
            { role: "user", content: userInput }
          ],
          temperature: 0.7,
        }),
        signal
      });

      if (!response.ok) {
        throw new Error(`API request failed with status ${response.status}`);
      }

      const data = await response.json();
      if (!data.choices || !data.choices[0]?.message?.content) {
        throw new Error("Invalid API response format");
      }
      return data.choices[0].message.content;
      */
      // Temporary mock response
      return "Mock response: API call should be implemented server-side.";
    }

    startBtn.addEventListener("click", async () => {
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        running = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        addToOutput(`Systems online. How may I assist you today, ${userName}?`, "system");
        
        initializeSpeechRecognition();
        startVoiceRecognition();
        
        if (window.responsiveVoice) {
          responsiveVoice.setDefaultVoice(currentLanguage === "hi-IN" ? "Hindi Male" : "UK English Male");
        }
        
      } catch (err) {
        console.error("Activation error:", err);
        addToOutput(`Activation failed: ${err.message}`, "system");
      }
    });

    stopBtn.addEventListener("click", () => {
      running = false;
      isSpeaking = false;
      stopVoiceRecognition();
      if (window.responsiveVoice) responsiveVoice.cancel();
      else window.speechSynthesis.cancel();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      addToOutput("Systems shutting down.", "system");
      
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
      }
    });

    startBtn.addEventListener("touchstart", async (e) => {
      e.preventDefault();
      startBtn.click();
    });

    stopBtn.addEventListener("touchstart", (e) => {
      e.preventDefault();
      stopBtn.click();
    });

    languageSelector.addEventListener("change", () => {
      if (running) {
        addToOutput(`Language set to ${languageSelector.value === "hi-IN" ? "Hindi" : "English"}`, "system");
        stopVoiceRecognition();
        currentLanguage = languageSelector.value;
        if (window.responsiveVoice) {
          responsiveVoice.setDefaultVoice(currentLanguage === "hi-IN" ? "Hindi Male" : "UK English Male");
        }
        initializeSpeechRecognition();
        if (!isSpeaking) startVoiceRecognition();
      }
    });

    stopBtn.disabled = true;

    window.addEventListener("load", function() {
      if (window.responsiveVoice && responsiveVoice.OnVoiceReady) {
        responsiveVoice.OnVoiceReady = function() {
          console.log("Voices loaded");
        };
      } else {
        console.log("Using Web Speech API as fallback");
        addToOutput("ResponsiveVoice unavailable. Using browser speech synthesis.", "system");
      }
    });
  </script>
</body>
</html>
